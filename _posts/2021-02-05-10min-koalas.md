---
title: "Koalas: ìŠ¤íŒŒí¬ì—ì„œ ì“°ëŠ” Pandas API"
date: 2021-02-05 11:33:00 +09:00
categories:
  - Posts
  - Data
tags:
  - spark
math: true
toc: true
comments: true
image: /assets/img/posts/2021-02-05-10min-koalas_1.png
---
> ì¤‘ê³ ì°¨ ê°€ê²© ë°ì´í„°ë¥¼ ê°€ì§€ê³  Koalasë¥¼ ì´ìš©í•œ UDF ì‘ì„±ê³¼ ë¨¸ì‹ ëŸ¬ë‹ì„ í•´ë´…ë‹ˆë‹¤.
{: .prompt-info }


PandasëŠ” ë³´í†µ ë°ì´í„° ë¶„ì„ì„ ë°°ìš¸ ë•Œ ê°€ì¥ ë¨¼ì € ì ‘í•˜ëŠ” ë„êµ¬ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ìê³ ë¡œ ë°ì´í„° ë¶„ì„ ê¸°ì´ˆ ì½”ìŠ¤ì˜ ë§¨ ì²« ì¤„ì´ë¼ë©´ íƒ€ì´íƒ€ë‹‰ ë°ì´í„°ì…‹ì„ `pd.read_csv` ë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒ ì•„ë‹ˆê² ì–´ìš”? ê·¸ë ‡ê²Œ Pandas ë°ì´í„°í”„ë ˆì„ì´ ì–´ë–»ê²Œ ìƒê²¼ëŠ”ì§€ ì‚´í´ë³´ê³ , ì¸ë±ì‹±ì„ í•˜ê±°ë‚˜ ì¹¼ëŸ¼ì„ ì¶”ê°€í•˜ê±°ë‚˜ í•˜ëŠ” ë°ì´í„°ë¥¼ ì „ì²˜ë¦¬ í•˜ëŠ” ë°©ë²• ë“±ì„ ì´ì–´ì„œ ë°°ìš°ê²Œ ë˜ê³ ìš”. íƒ€ì´íƒ€ë‹‰ ì´í›„ë¡œë„ ê³µë¶€ë¥¼ í•˜ê±°ë‚˜ ì‘ì€ ìˆ˜ì¤€ì˜ í”„ë¡œì íŠ¸ë¥¼ í•  ë•Œë„ pandasëŠ” ì¢‹ì€ ì¹œêµ¬ê°€ ë©ë‹ˆë‹¤.

ë¬¸ì œëŠ”, ì €ì˜ ê²½í—˜ì„ ë“¤ì–´ ì´ì•¼ê¸°í•´ë³´ë©´, ì˜ˆì „ì—ëŠ” ê·¸ë‹¤ì§€ í° ë°ì´í„°ì…‹ì„ ì ‘í•  ì¼ì´ ì—†ì—ˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. í•˜ì§€ë§Œ íšŒì‚¬ì— ì˜¤ë‹ˆ ë‹¤ë£¨ëŠ” ë°ì´í„°ì˜ í¬ê¸°ê°€ ì»¤ì¡Œê³  ìŠ¤íŒŒí¬ë¥¼ ë§Œë‚˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ê¸ˆì€ ë­ ë§¤ì¼ ì“°ë‹ˆê¹Œ pysparkê°€ í¸í•˜ì§€ë§Œ ì²˜ìŒ ì ‘í–ˆì„ ë•ŒëŠ” í™•ì‹¤íˆ ìµìˆ™í•´ì§€ëŠ” ë° ì‹œê°„ì´ ê±¸ë ¸ë˜ ê²ƒìœ¼ë¡œ ê¸°ì–µí•©ë‹ˆë‹¤. 

**Koalas**ëŠ” ì´ëŸ° ê²½ìš°ì— ìœ ìš©í•˜ê²Œ ì“¸ ìˆ˜ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ, ìŠ¤íŒŒí¬ì—ì„œ Pandas APIë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ì€ Koalas ë¥¼ ê°„ë‹¨íˆ ì‚¬ìš©í•´ë³´ê² ìŠµë‹ˆë‹¤. 

ê°œì¸ì ìœ¼ë¡œëŠ” ìŠ¤íŒŒí¬ ë°ì´í„°í”„ë ˆì„ì„ ë‹¤ë£¨ëŠ” ë°ì— ë³„ ë¶ˆí¸í•¨ì´ ì—†ê±°ë‚˜, ì´ì „ì— Pandasê°€ ìµìˆ™í•˜ì§€ ì•Šì•˜ë‹¤ë©´ Koalas ëŠ” í•„ìˆ˜ëŠ” ì•„ë‹Œ ê²ƒ ê°™ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë§Œì•½ Pandasë¥¼ ì˜ ì“°ê³  ìˆë˜ ì‚¬ëŒì´ë¼ë©´ **ìƒˆë¡œìš´ í”„ë ˆì„ì›Œí¬ì— ëŒ€í•œ ìŠµë“ ë¹„ìš© ì—†ì´ ë¶„ì‚° ì²˜ë¦¬ í™˜ê²½ìœ¼ë¡œ ì‰½ê²Œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆëŠ” ì§€ë¦„ê¸¸**ì´ ë  ìˆ˜ ìˆì„ ê²ƒì´ë¼ ìƒê°í•©ë‹ˆë‹¤.


![](/assets/img/posts/2021-02-05-10min-koalas_1.png)
_ì¸ìí•œ ë¯¸ì†Œì˜ ì½”ì•Œë¼...:)_

KoalasëŠ” ì´ë ‡ìŠµë‹ˆë‹¤.

- ëª¨ë“  Pandas API ì¤‘ 80% ì´ìƒì„ ì»¤ë²„í•œë‹¤. *ì•ˆ ë˜ëŠ”ê²ƒë„ ìˆì–´ì„œ  `PandasNotImplementedError` ê°€ ëœ° ìˆ˜ë„ ìˆë‹¤ (ê·¸ë˜ë„ ì ê¹ ì¨ë³´ë©´ì„œ ~~ë‚´ê°€ ì“¸ ì¤„ ì•Œì•˜ë˜~~ Pandas ì˜ ê¸°ëŠ¥ì€ ëŒ€ë¶€ë¶„ ëœë‹¤ëŠ” ì¸ìƒì„ ë°›ì•˜ë‹¤)
- Koalas ë°ì´í„°í”„ë ˆì„ì€ ë‚´ë¶€ì ìœ¼ë¡œëŠ” pyspark ë°ì´í„°í”„ë ˆì„ ìœ„ì—ì„œ ë§Œë“¤ì–´ì¡Œê³ (ë”°ë¼ì„œ lazyí•˜ë‹¤), ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” Pandas APIë¥¼ SPark SQLì˜ í”Œëœìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ì—­í• ì„ í•œë‹¤.
- Spark 3.0, Python 3.8, spark accessor, ìƒˆë¡œìš´ Type Hintë¥¼ ì§€ì›í•œë‹¤.

## ì¨ë³´ê¸°

`pip install koalas` ë¡œ ì„¤ì¹˜í•´ì£¼ê³ , ë‹¤ìŒê³¼ ê°™ì´ ë¶ˆëŸ¬ì˜¤ë©´ ë©ë‹ˆë‹¤.

```python
import databricks.koalas as ks
```

 [ì¤‘ê³ ì°¨ ê°€ê²©](https://www.kaggle.com/c/1056lab-used-cars-price-prediction/data) ë°ì´í„°ë¥¼ ì¨ ë´¤ìŠµë‹ˆë‹¤. ë³„ë¡œ í¬ê¸°ê°€ í¬ì§„ ì•Šì§€ë§Œ ë¹ ë¥´ê²Œ ì‚´í´ë³´ëŠ” ë° ì˜ì˜ë¥¼ ë‘ê² ìŠµë‹ˆë‹¤. ìŠ¤íŒŒí¬ ë°ì´í„°í”„ë ˆì„ì—ì„œ ì‹œì‘í•´ë³´ê² ìŠµë‹ˆë‹¤.

- ëŒ€ì¶© ìƒê¸´ ëª¨ì–‘ì€ ì´ë ‡ë‹¤. ì›ë³¸ ë°ì´í„°ì—ëŠ” ëª‡ëª‡ ë³€ìˆ˜ì— ë‹¨ìœ„ê°€ ë¶™ì–´ ìˆì—ˆëŠ”ë° `F.split(column, ' ')[0]` ìœ¼ë¡œ ë‹¨ìœ„ë¥¼ ì œê±°í•˜ê³  `.cast()` ë¡œ ìˆ˜ì¹˜í˜•ìœ¼ë¡œ ë³€í™˜í–ˆë‹¤.
```python
sdf.show(3)
>>
+--------------------+--------+----+-----------------+---------+------------+----------+-------+------+-----+-----+---------+-----+-------+
|                Name|Location|Year|Kilometers_Driven|Fuel_Type|Transmission|Owner_Type|Mileage|Engine|Power|Seats|New_Price|Price|  Name2|
+--------------------+--------+----+-----------------+---------+------------+----------+-------+------+-----+-----+---------+-----+-------+
|Maruti Wagon R LX...|  Mumbai|2010|          72000.0|      CNG|      Manual|     First|   26.6| 998.0|58.16|  5.0|     null| 1.75| Maruti|
|Hyundai Creta 1.6...|    Pune|2015|          41000.0|   Diesel|      Manual|     First|  19.67|1582.0|126.2|  5.0|     null| 12.5|Hyundai|
|        Honda Jazz V| Chennai|2011|          46000.0|   Petrol|      Manual|     First|   18.2|1199.0| 88.7|  5.0|8.61 Lakh|  4.5|  Honda|
+--------------------+--------+----+-----------------+---------+------------+----------+-------+------+-----+-----+---------+-----+-------+
only showing top 3 rows
```
    
- spark ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œë¶€í„° koalas ë°ì´í„°í”„ë ˆì„ ìƒì„±í•˜ê¸°
    
```python
kdf = sdf.to_koalas()
type(kdf)
>> Out[18]: databricks.koalas.frame.DataFrame
```
    
- ë‹¤ì‹œ ëŒë ¤ë†“ê¸°
    
```python
sdf_from_koalas = kdf.to_spark()
```
    
- ë¬¼ë¡  pandas ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œë¶€í„°ë„ ë§ˆì°¬ê°€ì§€ë¡œ ì™”ë‹¤ê°”ë‹¤ ê°€ëŠ¥í•˜ë‹¤.
    
```python
pdf = sdf.toPandas() #pandas DFë¡œ
kdf_from_pandas = ks.from_pandas(pdf)
pdf_from_koalas = kdf.toPandas() #ë‹¤ì‹œ ëŒë ¤ë†“ê¸°
```
    
- ì €ì¥ëœ íŒŒì¼ë¡œë¶€í„° ë¶ˆëŸ¬ì˜¬ ê²½ìš° pandasì™€ ë™ì¼í•˜ê²Œ `read_csv` ë¡œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìœ¼ë©° parquet ë„ ë™ì¼í•˜ê²Œ ê°€ëŠ¥, ì €ì¥í•  ë•Œë„ ë§ˆì°¬ê°€ì§€ - ì¦‰  `to_csv` / `read_parquet` / `to_parquet` í¸í•œ ëŒ€ë¡œ ì“°ë©´ ëœë‹¤.
![](/assets/img/posts/2021-02-05-10min-koalas_2.png)
ì´ë ‡ê²Œ ì–»ì€ koalas ë°ì´í„°í”„ë ˆì„ì„ ì‚´í´ë³´ë©´, ê·¸ëƒ¥ ë§ì´ ë³´ë˜ ê·¸ ëª¨ìŠµì…ë‹ˆë‹¤. pandas ë°ì´í„°í”„ë ˆì„ì„ í˜¸ì¶œí–ˆì„ ë•Œì™€ ë˜‘ê°™ì´ ìƒê²¼ì£ . ë‹¤ë¥¸ ê²ƒë“¤ë„ ë˜‘ê°™ì´ í•  ìˆ˜ ìˆëŠ”ì§€ ë´…ì‹œë‹¤.

- `df.describe()` ìœ¼ë¡œ ìˆ˜ì¹˜í˜• ë³€ìˆ˜ë“¤ì˜ ë¶„í¬ ì‚´í´ë³´ê¸° 
```python
kdf.describe()
```
   ![](/assets/img/posts/2021-02-05-10min-koalas_3.png)
- `groupby()` ì§‘ê³„ í›„ í†µê³„ì¹˜ êµ¬í•˜ê¸° - Fuel type ì— ë”°ë¥¸ í‰ê· 
```python
kdf.groupby('Fuel_Type').mean()
```
![](/assets/img/posts/2021-02-05-10min-koalas_4.png)
- `get_dummies()` ë¡œ ì¹´í…Œê³ ë¦¬ì»¬ ë³€ìˆ˜ ì²˜ë¦¬í•˜ê¸°
```python
ks.get_dummies(kdf['Fuel_Type']).head(5)
```
![](/assets/img/posts/2021-02-05-10min-koalas_5.png)
- ì“°ë‹¤ë³´ë‹ˆ ê·¸ëƒ¥ ë‹¤ ë˜‘ê°™ì€ ê²ƒ ê°™ë‹¤ ğŸ˜… `sort_index()` , `sort_values()` , `.fillna()` ,  `value_counts()` ë“± pandas ë¬¸ë²•ê³¼ ë™ì¼í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥
- í”Œë ê·¸ë¦¬ê¸° - ê°€ê²©ì˜ ë¶„í¬ íˆìŠ¤í† ê·¸ë¨
```python
kdf['Price'].plot.hist() 
```
![](/assets/img/posts/2021-02-05-10min-koalas_6.png)

- í”Œë ê·¸ë¦¬ê¸° 2 - ì¢Œì„ ìˆ˜ì— ë”°ë¥¸ ì°¨ì˜ ê°œìˆ˜ ë°” í”Œë
```python
kdf['Seats'].value_counts().plot(kind='barh')
```
![](/assets/img/posts/2021-02-05-10min-koalas_7.png)

ê²°ë¡ : pandas ì™€ ê±°ì˜ ë˜‘ê°™ì•„ì„œ ë­ ìƒˆë¡­ê²Œ ì ì„ ë§Œí•œ ê²Œ ì—†êµ°ìš”! ë„ì…ë¶€ì— ì ì—ˆë“¯ì´ koalasëŠ” pandasë¥¼ ìµìˆ™í•˜ê²Œ ì“°ì‹œëŠ” ë¶„ë“¤ì—ê²Œ ìœ ìš©í•  ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ ê¸€ë„ ì½ëŠ” ë¶„ë“¤ì´ pandasê°€ í¸í•˜ì‹œë‹¤ëŠ” ê°€ì • í•˜ì— ì“°ê³  ìˆìŠµë‹ˆë‹¤. ì¼ë‹¨ ë„˜ì–´ê°€ ë´…ì‹œë‹¤. 

## UDF

ìŠ¤íŒŒí¬ì—ì„œ ê·¸ë£¹ ë‹¨ìœ„ì˜ ì—°ì‚°ì„ í¸í•˜ê²Œ í•´ì£¼ëŠ” ê²ƒì´ ë°”ë¡œ Pandas UDF(User Defined Function; ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜)ì…ë‹ˆë‹¤. Pandas ë°ì´í„°í”„ë ˆì„ì„ ë‹¤ë£¨ë“¯ì´ í•¨ìˆ˜ë¥¼ ì‘ì„±í•˜ê³ , ì´ë¥¼ `sdf.groupBy().apply()` ì˜ í˜•íƒœë¡œ ê·¸ë£¹ ë‹¨ìœ„ë¡œ ìŠ¤íŒŒí¬ ë°ì´í„°í”„ë ˆì„ì— ì ìš©í•©ë‹ˆë‹¤. ë²¡í„°í™”ëœ ìˆ˜í–‰ì´ ê°€ëŠ¥í•˜ê³ , Scalaë¡œ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ë¹ ë¥¸ ì†ë„ì˜ ì—°ì‚°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. Pandas UDFë¥¼ í•œë²ˆ ì‘ì„±í•´ë³´ê³  ë™ì¼í•œ ëª©ì ìœ¼ë¡œ koalas ì—ì„œëŠ” ì–´ë–»ê²Œ ì“°ëŠ”ì§€ ë¹„êµí•´ ë³´ê² ìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ ê° **ìë™ì°¨ ë¸Œëœë“œ/íšŒì‚¬ ë³„ë¡œ** ë°ì´í„° ë‚´ 4ê°€ì§€ ìˆ˜ì¹˜í˜• ë³€ìˆ˜ë¥¼ ë…ë¦½ë³€ìˆ˜ë¡œ í•˜ê³ , ê°€ê²©ì„ ì¢…ì†ë³€ìˆ˜ë¡œ í•˜ëŠ” Ordinary least squares íšŒê·€ëª¨í˜•ì„ ë§Œë“¤ê³  ì‹¶ë‹¤ê³  í•©ì‹œë‹¤. ê·¸ë¦¬ê³  **ê·¸ë£¹ë³„ë¡œ ë³€ìˆ˜ë“¤ì˜ íšŒê·€ê³„ìˆ˜**ë¥¼ ì–»ê³ ì í•©ë‹ˆë‹¤. ì›ë³¸ ë°ì´í„°ì˜ ì°¨ì¢… ì¹¼ëŸ¼ì˜ ë§¨ ì•ë§Œ ë”°ì™€ì„œ `Name2` ë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. (ì˜ˆ -  `Audi A4 New 2.0 TDI Multitronic` â†’ `Audi` )

```python
import statsmodels.api as sm
group_column = 'Name2'
y_column = 'Price'
x_columns = ['Kilometers_Driven','Mileage','Engine','Power']
```

- pandas UDF

```python
from pyspark.sql.functions import pandas_udf, PandasUDFType
from pyspark.sql.types as T

schema = StructType([
StructField("Name2", T.StringType()),
StructField("Kilometers_Driven", T.FloatType()),
StructField("Power", T.FloatType()),
StructField("Engine", T.FloatType()),
StructField("Milegae,", T.FloatType())
])

@pandas_udf(schema, PandasUDFType.GROUPED_MAP)
def ols_pandasudf(pdf):
	group_key = pdf[group_column].iloc[0]
	y = pdf[y_column]
	X = pdf[x_columns]
	X = sm.add_constant(X)
	model = sm.OLS(y, X).fit()
	return pd.DataFrame([[group_key] + [model.params[i] for i in   x_columns]], columns=[group_column] + x_columns)

beta = car.groupBy(group_column).apply(ols_pandasudf)
```

- **koalas**

```python
def ols_ks( df ) -> ks.DataFrame[ 'Name2': str, 'Kilometers_Driven':float, 'Mileage':float, 'Engine':float , 'Power':float]:
  group_key = df[group_column].iloc[0]
  y = df[y_column]
  X = df[x_columns]
  X = sm.add_constant(X)
  model = sm.OLS(y, X).fit()
  
  return pd.DataFrame([[group_key] + [model.params[i] for i in   x_columns]])

beta_ks= kdf.groupby(group_column).apply(ols_ks)
``` 

pandas UDF ì‚¬ìš© ì‹œ ê°€ì¥ ì¤‘ìš”í•œ ì ì€ **ì¸í’‹ê³¼ ì•„ì›ƒí’‹ì´ ëª¨ë‘ pandas ë°ì´í„°í”„ë ˆì„ì´ ë˜ë„ë¡ ì‘ì„±í•˜ëŠ” ê²ƒì´ê³ , ìŠ¤í‚¤ë§ˆë¥¼ ì„  ì§€ì •**í•´ì¤˜ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ë°˜ë©´ koalas ë²„ì „ì˜ ê²½ìš° í•¨ìˆ˜ ì‘ì„± ì‹œ ì•„ì›ƒí’‹ koalas ë°ì´í„°í”„ë ˆì„ì— ëŒ€í•œ type hintingì„ í•˜ëŠ” ë¶€ë¶„ì´ ëˆˆì— ë•ë‹ˆë‹¤. ì´ë•Œ `-> ks.DataFrame[ str,float, float, float , float]` ì´ëŸ° ì‹ìœ¼ë¡œ typeë§Œ ì§€ì •í•´ì¤„ ìˆ˜ë„ ìˆì§€ë§Œ ê·¸ëŸ¬ë©´ ë¦¬í„´ë˜ëŠ” ë°ì´í„°í”„ë ˆì„ì— ì»¬ëŸ¼ ëª…ì´ ì„¤ì •ë˜ì§€ ì•Šìœ¼ë‹ˆ ìœ ì˜í•´ì•¼ í•©ë‹ˆë‹¤. `ks.DataFrame[zip(x.columns, x.dtypes)]` ì´ëŸ° ì‹ìœ¼ë¡œ ì„¤ì •í•´ë„ ë©ë‹ˆë‹¤.

ë”°ë¡œ ì½”ë“œë¥¼ ì²¨ë¶€í•˜ì§€ ì•Šì•˜ì§€ë§Œ ê·¸ëƒ¥ pandasë¡œ í•˜ë ¤ë©´ koalasë‚˜ spark dataframeì„ `toPandas()` ë¡œ ë³€í™˜ í›„ ì € ols í•¨ìˆ˜ ë‚´ì˜ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•´ì£¼ë©´ ë  ê²ƒì…ë‹ˆë‹¤. 

ì–´ë–¤ ë°©ì‹ì„ ì´ìš©í•˜ë“  ì–»ê²Œ ë˜ëŠ” ê³„ìˆ˜ ë°ì´í„°í”„ë ˆì„ì€ ë˜‘ê°™ìŠµë‹ˆë‹¤.

![](/assets/img/posts/2021-02-05-10min-koalas_8.png)

ì—¬ê¸°ê¹Œì§€ í•´ë³´ê³  ë‚˜ë‹ˆ ì†ë„ ì°¨ì´ê°€ ê¶ê¸ˆí•˜ë„¤ìš”. ìš°ë¦¬ê°€ ì§€ê¸ˆ ì‚¬ìš©í•˜ëŠ” ë°ì´í„°ëŠ” í¬ê¸°ê°€ ì •í•´ì ¸ ìˆìœ¼ë‹ˆ [ì´ ê¸€](https://databricks.com/blog/2019/08/22/guest-blog-how-virgin-hyperloop-one-reduced-processing-time-from-hours-to-minutes-with-koalas.html) ì„ ì°¸ê³ í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë°ì´í„°ì˜ í¬ê¸°ì— ë”°ë¼ pandas ì™€ pyspark, koalasê°€ ì¼ë°˜ í•¨ìˆ˜ì™€ UDF ì‘ì„± ì‹œ ê°ê° ê±¸ë¦¬ëŠ” ì‹œê°„ì´ ì–´ë–»ê²Œ ë‹¬ë¼ì§€ëŠ”ì§€ ì‹¤í—˜í•œ ë‚´ìš©ì…ë‹ˆë‹¤. ì‹¤í—˜ ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ê³ ìš”.

- Spark driver node : 8 CPU cores, 61GB RAM
- 15 Spark worker nodes: 4CPU cores, 30.5GB RAM each (sum: 60CPUs / 457.5GB )

![](/assets/img/posts/2021-02-05-10min-koalas_9.png)
![](/assets/img/posts/2021-02-05-10min-koalas_10.png)

ê±¸ë¦° ì‹œê°„ì´ë¯€ë¡œ ì§§ì„ìˆ˜ë¡ ì¢‹ìŠµë‹ˆë‹¤. ë°ì´í„° ìˆ˜ê°€ ì ì„ ë•ŒëŠ” pandasê°€ ë¹ ë¦…ë‹ˆë‹¤. ë‹¤ë§Œ ë°ì´í„°ì˜ í–‰ ê°œìˆ˜ê°€ ëŠ˜ì–´ë‚ ìˆ˜ë¡ pysparkì´ ì›”ë“±íˆ ë¹¨ë¼ì§€ê³ , koalasëŠ” ê·¸ë³´ë‹¨ ì¡°ê¸ˆ ëª»í•˜ì§€ë§Œ ê±°ì˜ ë¹„ìŠ·í•œ ìˆ˜ì¤€ì˜ ì‹œê°„ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

## ë¨¸ì‹ ëŸ¬ë‹

ë§ˆì§€ë§‰ìœ¼ë¡œ ì¤‘ê³ ì°¨ ê°€ê²©ì„ ì˜ˆì¸¡í•˜ëŠ” íšŒê·€ ëª¨ë¸ì„ ì í•©ì‹œì¼œë³´ê² ìŠµë‹ˆë‹¤. koalas ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ì£¼ì–´ì§„ ë°ì´í„°ì— ëŒ€í•´ ë¨¸ì‹ ëŸ¬ë‹ì„ í•´ë³¼ ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì¼ë‹¨ ë‘ ê°€ì§€ ì •ë„ê°€ ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. 

###  1) í›ˆë ¨ëœ ëª¨ë¸ì„ MLflowë¡œ ì €ì¥í•˜ê³  ë¶ˆëŸ¬ì™€ì„œ Koalas ë°ì´í„°í”„ë ˆì„ì— ëŒ€í•œ predictorë¡œ ì‚¬ìš©í•œë‹¤.

[MLflow](https://mlflow.org)ëŠ” (ë§ˆì°¬ê°€ì§€ë¡œ ë°ì´í„°ë¸Œë¦­ìŠ¤ì—ì„œ ë§Œë“ ) ë¨¸ì‹ ëŸ¬ë‹ ë¼ì´í”„ì‚¬ì´í´ì„ ìœ„í•œ ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼ì…ë‹ˆë‹¤. ìŠ¤ì¼€ì¼ë§ í›„ ë°ì´í„°ë¥¼ íŠ¸ë ˆì´ë‹/í…ŒìŠ¤íŠ¸ ì…‹ìœ¼ë¡œ ë‚˜ëˆ„ê³ , sklearnì˜ ì„ í˜•íšŒê·€ ëª¨ë¸ì„ í›ˆë ¨ì‹œí‚¤ê³ , ëª¨ë¸ì„ ì €ì¥í•´ ë‘¡ë‹ˆë‹¤. ìˆ˜ì¹˜í˜• ë³€ìˆ˜ë“¤ 4ê°œë§Œ ì‚¬ìš©í•´ ë´¤ìŠµë‹ˆë‹¤.

```python
from mlflow.tracking import MlflowClient, set_tracking_uri
import mlflow.sklearn
from tempfile import mkdtemp
d = mkdtemp("koalas_mlflow")
set_tracking_uri("file:%s"%d)
client = MlflowClient()
exp = mlflow.create_experiment("r_experiment")
mlflow.set_experiment("r_experiment")
```

ìš°ì„  ì´ë ‡ê²Œ MLflow í™˜ê²½ì„ ì´ˆê¸°í™”í•´ì¤ë‹ˆë‹¤.

```python
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.linear_model import LinearRegression
import numpy as np

import mlflow.sklearn
import mlflow

data = kdf.to_pandas()
scaler_x = StandardScaler()
scaler_y = StandardScaler()
X = data[['Kilometers_Driven','Mileage','Engine','Power']].values
X = scaler_x.fit_transform(X)
Y = data[['Price']].values
Y = scaler_y.fit_transform(Y)

x_train, x_test, y_train, y_test = train_test_split(X, Y, test_size=0.25, random_state=0)

def train_and_score_model():
  with mlflow.start_run():
    regressor = LinearRegression()
    regressor.fit(x_train,y_train)
    score = regressor.score(X=x_test, y=y_test)
    
    # log run the model result to mlflow
    mlflow.sklearn.log_model(regressor, artifact_path="model")
    mlflow.log_metric("r2", score)
  return score

train_and_score_model()
```

0.59 ì •ë„ì˜ R2 ìŠ¤ì½”ì–´ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤. koalas.mlflowëŠ” ì´ ì €ì¥ëœ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆë„ë¡ ì§€ì›í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¨ í›„, ìƒˆë¡œìš´ ì˜ˆì¸¡ ë°ì´í„°(koalas ë°ì´í„°í”„ë ˆì„)ì„ ìƒì„±í•˜ì—¬ ì˜ˆì¸¡ê°’ì„ ì–»ì–´ ë³´ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.

```python
from databricks.koalas.mlflow import load_model
run_info = client.list_run_infos(exp)[-1]
model = load_model("runs:/{run_id}/model".format(run_id=run_info.run_uuid))

prediction_df = ks.DataFrame({'Kilometers_Driven':[5000],'Mileage':[266.6],'Engine':[1200],'Power': [58]})
prediction_df["prediction"] = model.predict(prediction_df)
prediction_df
```

![](/assets/img/posts/2021-02-05-10min-koalas_11.png)

### 2) ê·¸ëƒ¥ SparkMLì„ ì“´ë‹¤.

ê°„í¸í•˜ê²Œ ìŠ¤íŒŒí¬ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜ ê°€ëŠ¥í•˜ë¯€ë¡œ ê·¸ëƒ¥ SparkMLì„ ì“°ëŠ” ê²ƒë„ ë°©ë²•ì…ë‹ˆë‹¤. ìŠ¤íŒŒí¬ì˜ ë¨¸ì‹ ëŸ¬ë‹ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ, ë‹¤ì–‘í•œ í”¼ì³ì—”ì§€ë‹ˆì–´ë§ ê¸°ëŠ¥ê³¼ íšŒê·€, ë¶„ë¥˜, í´ëŸ¬ìŠ¤í„°ë§ ë“± ML ì•Œê³ ë¦¬ì¦˜ì´ ì§€ì›ë©ë‹ˆë‹¤. ì´ë²ˆì—ëŠ” ê·¸ë˜ë””ì–¸íŠ¸ ë¶€ìŠ¤íŒ… íšŒê·€ ëª¨ë¸ì„ ì í•©ì‹œì¼œë³´ê² ìŠµë‹ˆë‹¤.

```python
from pyspark.ml.feature import VectorAssembler
from pyspark.ml.evaluation import RegressionEvaluator
from pyspark.ml.regression import GBTRegressor

sdf = kdf.to_spark()
vectorAssembler = VectorAssembler(inputCols =['Kilometers_Driven','Mileage','Engine','Power'], outputCol = "features")
vdata = vectorAssembler.transform(sdf)
splits = vdata.randomSplit([0.7,0.3])
train_df = splits[0]
test_df = splits[1]

gbt = GBTRegressor(featuresCol="features", labelCol="Price")
gbt_model = gbt.fit(train_df)
gbt_predictions = gbt_model.transform(test_df)
```

Evaluatorë¥¼ í™œìš©í•´ì„œ R2 score í™•ì¸ ê²°ê³¼ 0.75ì…ë‹ˆë‹¤.

```python
gbt_evaluator = RegressionEvaluator(labelCol="Price", predictionCol="prediction", metricName="r2")
gbt_r2 = gbt_evaluator.evaluate(gbt_predictions)
print(gbt_r2)
```

`.transform()` ë©”ì†Œë“œë¡œ ë§Œë“¤ì–´ì§„ prediction ë°ì´í„°í”„ë ˆì„ì€ ê¸°ì¡´ ì •ë³´ë“¤ì„ ê·¸ëŒ€ë¡œ ë³´ì¡´í•œ ì±„ë¡œ prediction ë§Œ ì¶”ê°€í•œ í˜•íƒœì´ë¯€ë¡œ ì´ë¥¼ ë‹¤ì‹œ koalas ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ëŒë ¤ì£¼ë©´ ì•„ë˜ì™€ ê°™ì´ ì˜ˆì¸¡ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
kdf_predictions = ks.DataFrame(gbt_predictions)
kdf_predictions.head(3)
```

![](/assets/img/posts/2021-02-05-10min-koalas_12.png)

## ì°¸ê³ í•œ ê¸€ë“¤

- [Koalas: Easy Transition from pandas to Apache Spark](https://databricks.com/blog/2019/04/24/koalas-easy-transition-from-pandas-to-apache-spark.html)
- [Guest Blog: How Virgin Hyperloop One Reduced Processing Time from Hours to Minutes with Koalas](https://databricks.com/blog/2019/08/22/guest-blog-how-virgin-hyperloop-one-reduced-processing-time-from-hours-to-minutes-with-koalas.html)
- [Koalas: Pandas on Apache Spark (Tutorial)](https://www.slideshare.net/databricks/koalas-pandas-on-apache-spark)
- [Machine Learning with Koalas and Spark](https://towardsdatascience.com/koalas-ml-4807f2c56e98)
- [Koalas docs](https://koalas.readthedocs.io/en/latest/reference/api/databricks.koalas.mlflow.load_model.html)